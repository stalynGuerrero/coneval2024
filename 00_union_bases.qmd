# 00_union_bases.R

```{r, echo=FALSE, warning=FALSE,error=FALSE, message=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE)
library(printr)
library(kableExtra)
library(tidyverse)
rstan::rstan_options(auto_write = TRUE) # speed up running time 
tba <- function(dat, cap = NA){
  kable(dat,
      format = "html", digits =  4,
      caption = cap) %>% 
     kable_styling(bootstrap_options = "striped", full_width = F)%>%
         kable_classic(full_width = F, html_font = "Arial Narrow")
}
```

Para la ejecución del presente archivo, debe abrir el archivo **00_union_bases.R** disponible en la ruta *Rcodes/2020/00_union_bases.R*.

El código comienza limpiando el entorno de R y cargando varias bibliotecas esenciales para la manipulación y análisis de datos. Posteriormente, define un conjunto de variables a validar y obtiene listas de archivos de datos en formato `.dta` correspondientes a diferentes conjuntos de datos del censo 2020. A continuación, el código itera sobre estos archivos para leer, combinar y almacenar los datos de cada estado en archivos `.rds` individuales. Estos datos se combinan en un único dataframe que se guarda para su uso posterior.

En la sección final, el código se centra en los datos de la ENIGH 2020. Lee los archivos de hogares y pobreza, y los combina utilizando un `inner_join`. Se seleccionan y renombran variables clave para asegurar la consistencia en el análisis. Finalmente, el dataframe combinado se guarda en un archivo `.rds` para facilitar el acceso y análisis futuros.


```{r, eval=FALSE}
rm(list = ls())

#################
### Libraries ###
#################
library(tidyverse)
library(data.table)
library(openxlsx)
library(magrittr)
library(DataExplorer)
library(haven)
library(purrr)
library(furrr)
library(labelled)
cat("\f")

###############################################################
validar_var <- c(
  "ic_rezedu",
  "ic_asalud",
  "ic_segsoc",
  "ic_cv",
  "ic_sbv",
  "ic_ali_nc",
  "ictpc"
)
# Obtener la lista de archivos .dta

file_muestra_censo_2020_estado <-
  list.files(
    "../input/2020/muestra_ampliada/SegSocial/SegSoc/",
    full.names = TRUE,
    pattern = "dta$"
  )
file_muestra_censo_2020_estado_complemento <-
  list.files(
    "../input/2020/muestra_ampliada/SegSocial/Complemento_SegSoc/",
    full.names = TRUE,
    pattern = "dta$"
  )

muestra_cuestionario_ampliado_censo_2020_estado <-
  list.files(
    "../input/2020/muestra_ampliada/IndicadoresCenso/",
    full.names = TRUE,
    pattern = "dta$"
  )


# Crear un dataframe vacío para almacenar los datos
df <- data.frame()

# Iterar sobre cada archivo y leerlo
for (ii in 1:32) {
  muestra_censo_2020_estado_ii <-
    read_dta(file_muestra_censo_2020_estado[ii])
  muestra_censo_2020_estado_complemento_ii <-
    read_dta(file_muestra_censo_2020_estado_complemento[ii]) %>%
    mutate(id_per = id_persona)
  muestra_cuestionario_ampliado_censo_2020_estado_ii <-
    read_dta(muestra_cuestionario_ampliado_censo_2020_estado[ii])
  
  muestra_censo <-
    inner_join(muestra_censo_2020_estado_ii,
               muestra_censo_2020_estado_complemento_ii) %>%
    select(-tamloc) %>%
    inner_join(muestra_cuestionario_ampliado_censo_2020_estado_ii)
  
  saveRDS(muestra_censo,
          paste0("../output/2020/muestra_censo/depto_", ii, ".rds"))
  
  df <- bind_rows(df, muestra_censo)
  cat(file_muestra_censo_2020_estado[ii], "\n")
}

# Guardar el dataframe en un archivo .rds
saveRDS(df, file = "../output/2020/muestra_cuestionario_ampliado.rds")

intersect(names(df), validar_var)
dim(df)
# "ic_cv"     "ic_sbv"    "ic_rezedu" "ic_asalud"


################################################################################
# enigh
################################################################################

# enigh_personas <- read_dta("input/2020/enigh/base_personas_MEC20.dta")
enigh_hogares <- read_dta("../input/2020/enigh/base_hogares20.dta")
enigh_pobreza <- read_dta("../input/2020/enigh/pobreza_20.dta") %>% 
  select(-ent)

n_distinct(enigh_pobreza$folioviv)
n_distinct(enigh_hogares$folioviv)

enigh <- inner_join(
  enigh_pobreza,
  enigh_hogares,
  by = join_by(
    folioviv, foliohog, est_dis, upm,
    factor, rururb, ubica_geo
  ), 
  suffix = c("_pers", "_hog"),
)

enigh$ic_ali_nc
enigh$ictpc_pers
enigh$ictpc <- enigh$ictpc_pers
enigh$ic_segsoc

saveRDS(enigh, file = "../output/2020/enigh.rds")


```

